{% extends 'base.html' %}
{% block title %}AI Academic Stats | Student Info System{% endblock %}
{% block content %}
<div class="page-header">
  <h1><i class="fas fa-brain me-3"></i>AI-Powered Academic Analytics</h1>
  <p>Get intelligent insights into student performance with AI-driven analysis and recommendations.</p>
</div>

<!-- Filter Section -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Students</h5>
  </div>
  <div class="card-body">
    <form method="GET" class="row g-3">
      <div class="col-md-4">
        <label for="class" class="form-label">Class</label>
        <select class="form-select" id="class" name="class">
          <option value="">All Classes</option>
          {% for class_name in classes %}
            <option value="{{ class_name }}" {% if selected_class == class_name %}selected{% endif %}>{{ class_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="section" class="form-label">Section</label>
        <select class="form-select" id="section" name="section">
          <option value="">All Sections</option>
          {% for section_name in sections %}
            <option value="{{ section_name }}" {% if selected_section == section_name %}selected{% endif %}>{{ section_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="student_id" class="form-label">Select Student</label>
        <select class="form-select" id="student_id" name="student_id">
          <option value="">Choose a student for detailed analysis</option>
          {% for student in students %}
            <option value="{{ student.id }}" {% if selected_student_data and selected_student_data.student.id == student.id %}selected{% endif %}>
              {{ student.name }} ({{ student.class }}-{{ student.section }})
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search me-2"></i>Apply Filters
        </button>
        <a href="{{ url_for('ai_academic_stats') }}" class="btn btn-secondary ms-2">
          <i class="fas fa-refresh me-2"></i>Reset
        </a>
      </div>
    </form>
  </div>
</div>

{% if class_stats %}
<!-- Class Statistics -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card bg-primary text-white">
      <div class="card-body text-center">
        <i class="fas fa-chart-line fa-2x mb-2"></i>
        <h4>{{ class_stats.avg_class_marks }}%</h4>
        <small>Class Average</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <i class="fas fa-trophy fa-2x mb-2"></i>
        <h4>{{ class_stats.max_class_marks }}%</h4>
        <small>Highest Score</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-warning text-white">
      <div class="card-body text-center">
        <i class="fas fa-chart-bar fa-2x mb-2"></i>
        <h4>{{ class_stats.min_class_marks }}%</h4>
        <small>Lowest Score</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <i class="fas fa-calendar-check fa-2x mb-2"></i>
        <h4>{{ class_stats.avg_attendance }} days</h4>
        <small>Avg Attendance</small>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if selected_student_data %}
<!-- AI Analysis Results -->
<div class="row">
  <div class="col-lg-8">
    <!-- Student Overview -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-user-graduate me-2"></i>
          {{ selected_student_data.student.name }} - AI Analysis
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="d-flex align-items-center mb-3">
              <div class="avatar-lg me-3">
                <i class="fas fa-user-circle fa-4x text-primary"></i>
              </div>
              <div>
                <h4 class="mb-1">{{ selected_student_data.student.name }}</h4>
                <p class="text-muted mb-0">ID: {{ selected_student_data.student.id }}</p>
                <p class="text-muted mb-0">{{ selected_student_data.student.class }}-{{ selected_student_data.student.section }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="row g-2">
              <div class="col-6">
                <div class="card bg-light border-0">
                  <div class="card-body text-center p-3">
                    <i class="fas fa-chart-line text-primary mb-2"></i>
                    <h6 class="mb-1">{{ selected_student_data.avg_marks }}%</h6>
                    <small class="text-muted">Average Marks</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-light border-0">
                  <div class="card-body text-center p-3">
                    <i class="fas fa-calendar-check text-success mb-2"></i>
                    <h6 class="mb-1">{{ selected_student_data.attendance_percentage }}%</h6>
                    <small class="text-muted">Attendance</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Insights -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-brain me-2"></i>AI Insights</h5>
      </div>
      <div class="card-body">
        <!-- Performance Level -->
        <div class="alert alert-info">
          <h6><i class="fas fa-star me-2"></i>Performance Level: {{ selected_student_data.ai_insights.performance_level }}</h6>
          <p class="mb-0">{{ selected_student_data.ai_insights.overall_assessment }}</p>
        </div>

        <!-- Strengths -->
        {% if selected_student_data.ai_insights.strengths %}
        <div class="mb-3">
          <h6 class="text-success"><i class="fas fa-thumbs-up me-2"></i>Strengths</h6>
          <ul class="list-group list-group-flush">
            {% for strength in selected_student_data.ai_insights.strengths %}
              <li class="list-group-item bg-success bg-opacity-10">
                <i class="fas fa-check-circle text-success me-2"></i>{{ strength }}
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Weaknesses -->
        {% if selected_student_data.ai_insights.weaknesses %}
        <div class="mb-3">
          <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
          <ul class="list-group list-group-flush">
            {% for weakness in selected_student_data.ai_insights.weaknesses %}
              <li class="list-group-item bg-warning bg-opacity-10">
                <i class="fas fa-exclamation-circle text-warning me-2"></i>{{ weakness }}
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Recommendations -->
        <div class="mb-3">
          <h6 class="text-primary"><i class="fas fa-lightbulb me-2"></i>AI Recommendations</h6>
          <ul class="list-group list-group-flush">
            {% for recommendation in selected_student_data.ai_insights.recommendations %}
              <li class="list-group-item bg-primary bg-opacity-10">
                <i class="fas fa-arrow-right text-primary me-2"></i>{{ recommendation }}
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Trend Analysis -->
        {% if selected_student_data.ai_insights.trend_analysis %}
        <div class="alert alert-secondary">
          <h6><i class="fas fa-chart-line me-2"></i>Trend Analysis</h6>
          <p class="mb-0">{{ selected_student_data.ai_insights.trend_analysis }}</p>
        </div>
        {% endif %}

        <!-- Attendance Impact -->
        {% if selected_student_data.ai_insights.attendance_impact %}
        <div class="alert alert-info">
          <h6><i class="fas fa-calendar me-2"></i>Attendance Impact</h6>
          <p class="mb-0">{{ selected_student_data.ai_insights.attendance_impact }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Subject Performance -->
    {% if selected_student_data.subject_performance %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Subject Performance</h5>
      </div>
      <div class="card-body">
        {% for subject, marks in selected_student_data.subject_performance.items() %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold">{{ subject }}</span>
            <span class="badge {% if marks >= 80 %}bg-success{% elif marks >= 70 %}bg-warning{% else %}bg-danger{% endif %}">
              {{ marks }}%
            </span>
          </div>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar {% if marks >= 80 %}bg-success{% elif marks >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                 style="width: {{ marks }}%"></div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Grades -->
    {% if selected_student_data.grades %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>Grades</h5>
      </div>
      <div class="card-body">
        {% for subject, grade in selected_student_data.grades.items() %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>{{ subject }}</span>
            <span class="badge bg-secondary">{{ grade }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Quick Stats -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Quick Statistics</h5>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-6">
            <div class="text-center p-2 bg-light rounded">
              <h6 class="mb-1">{{ selected_student_data.max_marks }}%</h6>
              <small class="text-muted">Highest Score</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-2 bg-light rounded">
              <h6 class="mb-1">{{ selected_student_data.min_marks }}%</h6>
              <small class="text-muted">Lowest Score</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-2 bg-light rounded">
              <h6 class="mb-1">{{ selected_student_data.subject_performance|length }}</h6>
              <small class="text-muted">Subjects</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center p-2 bg-light rounded">
              <h6 class="mb-1">{{ selected_student_data.attendance_days }}</h6>
              <small class="text-muted">Days Present</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% else %}
<!-- Student List -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Select a Student for AI Analysis</h5>
  </div>
  <div class="card-body">
    {% if students %}
      <div class="row">
        {% for student in students %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="avatar me-3">
                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1">{{ student.name }}</h6>
                    <p class="text-muted mb-1">{{ student.class }}-{{ student.section }}</p>
                    <small class="text-muted">ID: {{ student.id }}</small>
                  </div>
                </div>
                <div class="mt-3">
                  <a href="{{ url_for('ai_academic_stats', student_id=student.id, class=selected_class, section=selected_section) }}" 
                     class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-brain me-2"></i>Analyze with AI
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-4">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5>No students found</h5>
        <p class="text-muted">Try adjusting your filters or add students to the system.</p>
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="mt-4">
  <a href="{{ url_for('reports_dashboard') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Reports
  </a>
</div>
{% endblock %} 